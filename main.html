<!DOCTYPE html>
<html>
<head>
    <title>CitiBike Stations</title>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script src="https://d3js.org/d3-path.v2.min.js"></script>
    <script src="https://d3js.org/d3-shape.v2.min.js"></script>
    <script src="https://d3js.org/topojson.v1.min.js"></script>
    <script src="https://d3js.org/d3-array.v2.min.js"></script>
    <script src="https://d3js.org/d3-geo.v2.min.js"></script>
    <script src="https://d3js.org/d3-geo-projection.v3.min.js"></script>
    <script src="https://unpkg.com/react/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone/babel.js"></script>
    
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
    const csvUrl = 'https://raw.githubusercontent.com/ian-Liaozy/Information-Visualization-Spring-2021-Final-Project/main/Updated%20Data.csv';
    const mapUrl = "https://raw.githubusercontent.com/ian-Liaozy/Information-Visualization-Spring-2021-Final-Project/main/china.json";
    const mapData ='https://raw.githubusercontent.com/ian-Liaozy/Information-Visualization-Spring-2021-Final-Project/main/mapcount.csv';
    function useData(csvPath){
        const [dataAll, setData] = React.useState(null);
        React.useEffect(() => {
            d3.csv(csvPath).then(data => {
                data.forEach(d => {
                    d.like = +d.like;
                });
                setData(data);
            });
        }, []);
        return dataAll;
    }
    function useMapData(csvPath){
        const [dataAll, setData] = React.useState(null);
        React.useEffect(() => {
            d3.csv(csvPath).then(data => {
                data.forEach(d => {
                    d.latitude = +d.latitude;
                    d.longitude = +d.longitude;
                    d.count = +d.count;
                    //derive a new attribute: popularity
                });
                setData(data);
            });
        }, []);
        return dataAll;
    }

    
//symbol map start --------------------------------------------------------------------------------------------------------
    function useMap(jsonPath) {
        const [data, setData] = React.useState(null);
        React.useEffect(() => {
            d3.json(jsonPath).then(geoJsonData => {
                setData(geoJsonData);
            })
        }, []);
        return data;
    }

    function SymbolMap(props) {
        const {x, y, map, data, height, width,location,setLocation,dataAll,mouseOver,mouseOut,hovlocation,setHovlocation,click,unclick} = props;
        const projection = d3.geoMercator().fitSize([width, height], map);
        const path = d3.geoPath(projection);
        const radius = d3.scalePow().exponent(0.7).range([6, 140])
            .domain([d3.min(dataAll, d => d.count), d3.max(dataAll, d => d.count)]); 

        return <g transform={`translate(${x}, ${y})`}>
             {map.features.map((feature, idx) => {
                return <path key={idx+"boundary"} className={"boundary"} d={path(feature)}
                onClick={unclick}
               />
            })}
            {map.features.filter(d => d.properties.name === hovlocation).map((feature, idx) => {
                return<g> 
                <path key={idx+"boundary"} className={"selectedBoundary"} d={path(feature)} />
                 </g>
            })}
            {dataAll.filter(d => d.location === hovlocation).map( d => {
                const [x, y] =  projection([ d.latitude,d.longitude]);//not interchangable 
                return <g transform={`translate(${x-30}, ${y-30})`}>
                <text>{hovlocation}</text>
                <text transform={`translate(${0}, ${20})`}>Comment Count:{d.count}</text>
                 </g>
            })}
            {data.map(d => {
                const [x, y] =  projection([ d.latitude,d.longitude]);//not interchangable 
                return  <circle key={"location" + d.longitude+d.latitude} cx={x} cy={y+2}  r={2} opacity={0.8} 
                className={"sphereCenter"}  />
            })}
            {data.map(d => {
                const [x, y] =  projection([ d.latitude,d.longitude]);//not interchangable 
                return <circle key={"location" + d.longitude+d.latitude} cx={x} cy={y+2}  r={radius(d.count)} opacity={0.65} 
                className={"sphere"} onMouseOver={() => mouseOver(d)} onMouseOut={mouseOut} onClick={() => click(d)} />
                
            })}
            </g>
    }

//symbol map end --------------------------------------------------------------------------------------------------------

//bar chart start --------------------------------------------------------------------------------------------------------
    function BarChart(props) {
        const {data,width, height,margin,barMode,dataSelected,location} = props;
        const xScaleDay = d3.scaleBand()
                    .range ([0, width])
                    .padding(0.05)
                    .domain(data.map(function(d) { return d.day; }));
                
        const yScaleDay = d3.scaleLinear()
                    .range([height, 0])
                    .domain([0, d3.max(data, d => d.count)])
                    .nice(); 
        
        
        return <g transform={`translate(${margin.left}, ${margin.top*2})`}>
            <Bars location={location} data={data} xScale={xScaleDay} yScale={yScaleDay} width={width} height={height}barMode={barMode} dataSelected={dataSelected}/>
            <YAxis yScale={yScaleDay} height={height} barMode={barMode}/>
            <XAxis data={data} xScale={xScaleDay} width={width} height={height} barMode={barMode}/>
            </g>
        } 
    function YAxis(props) {
        const {yScale, height,barMode} = props;
        var ticks;
        var size;
        if(barMode==2) {ticks = yScale.ticks(9);size='12px';}
        else if(barMode==1) {ticks = yScale.ticks(5);size='15px';}
        return <g>
            <line y2={height} stroke={`black`}  strokeWidth={"2px"}/>
            {ticks.map( tickValue => {
                return <g key={tickValue} transform={`translate(-10, ${yScale(tickValue)})`}>
                        <line x2={10} stroke={"black"} />
                        <text style={{ textAnchor:'end', fontSize:size }}>
                        {tickValue}
                        </text>
                    </g> 
            })}
        </g>    
        }
    function XAxis(props) {
        const {xScale, width, height,data,barMode} = props;     
        const xAxis = d3.axisBottom(xScale).tickValues(xScale.domain());
             //const ticks = xScale.ticks();
        var size;
        var xgap;
        if(barMode==2) {size='12px';xgap=3;}
        else if(barMode==1) {size='15px';xgap=-7;}
        return <g>
                <line x1={0} y1={height} x2={width} y2={height} stroke={`black`} strokeWidth={"2px"}/>
                {data.map(d => {
                    return <g key={d.day} transform={`translate(${xScale(d.day)+5-xgap}, ${height-5})`}>
                            <text style={{ textAnchor:'start', fontSize:size}} y={20}>
                            {d.day.slice(0, 3)}
                            </text>
                    </g> 
                    })}
                </g>     
    }
    
    function Bars(props) {
        const {data, xScale, yScale, width, height,barMode,dataSelected,location} = props;
        if(location==null){
            return <g>
                {data.map(d => {
                    return <rect key={d.day} x={xScale(d.day)} 
                    y={yScale(d.count)} 
                    width={xScale.bandwidth()}
                    height={height-yScale(d.count)}
                    className={"bar"} stroke={"black"}  
                    />
                })} </g>
        }
        else{return <g>
                {data.map(d => {
                    return <rect key={d.day} x={xScale(d.day)} 
                    y={yScale(d.count)} 
                    width={xScale.bandwidth()}
                    height={height-yScale(d.count)}
                    className={"bar"} stroke={"black"}  
                    />
                })}
                {dataSelected.map(d => {
                    return <rect key={d.day} x={xScale(d.day)} 
                    y={yScale(d.count)} 
                    width={xScale.bandwidth()}
                    height={height-yScale(d.count)}
                    className={"barSelected"} stroke={"black"}  
                    />
                })}
            </g>
        } 
    }
    
//bar chart end --------------------------------------------------------------------------------------------------------
    const Graph = () => {
        const [location, setLocation] = React.useState(null);
        const [hovlocation, setHovlocation] = React.useState(null);
        const [barMode, setbarMode] = React.useState(2);//1:day;2:hour
        const dataAll = useData(csvUrl);
        const map = useMap(mapUrl);
        var locationList=useMapData(mapData);
        var locationAll=useMapData(mapData);
        if (!map || !dataAll||!locationList||!locationAll) {
                return <pre>Loading...</pre>;
            };
        var data;

        if(location==null){
                data= dataAll
            }
        else if((location!=null)) {
         data = dataAll.filter( d=> {
            return d.location == location;
        }); 
        locationList= locationList.filter( d=> {
           return d.location == location;
        }); 
       }
       

        //symbol map constants start --------------------------------------------------------------------------------------------------------
        const MAPWIDTH = 2000;
        const MAPHEIGHT = 1200;
        const mapmargin = { top: 20, right: 40, bottom: 160, left: 40, gap:40 };
        const mapinnerWidth = MAPWIDTH - mapmargin.left - mapmargin.right - mapmargin.gap;
        const mapinnerHeight = MAPHEIGHT - mapmargin.top - mapmargin.bottom - mapmargin.gap; 
       // for (var i = 0; i < locationAll.length; i++){
           //locationAll[i].count=0;
          // locationList[i].count=0;
        //} 
         for (var i = 0; i < dataAll.length; i++){
            var comment=dataAll[i]
            for (var j=0;j<locationAll.length;j++){
                if(comment.location==locationAll[j].location){
                    locationAll[j].count+=1;
                    break;
                }
            }
        }  
  
         for (var i = 0; i < data.length; i++){
            var comment=data[i]
            for (var j=0;j<locationList.length;j++){
                if(comment.location==locationList[j].location){
                    locationList[j].count+=1;
                    break;
                }
            }
        }  
        
        locationList.sort(function(a, b) {
            return b.count - a.count;
        });
        const mouseOver = d => {
            setHovlocation(d.location);
        };
        const mouseOut = () => {
            setHovlocation(null);
        };
        const click= d => {
            setLocation(d.location);
        };
        const unclick = () => {
            setLocation(null);
        };
        //symbol map constants end --------------------------------------------------------------------------------------------------------

        //bar chart constants start --------------------------------------------------------------------------------------------------------
        var dayList=[{day:"Monday",count:0,},{day:"Tuesday",count:0,},{day:"Wednesday",count:0,},{day:"Thursday",count:0,},
        {day:"Friday",count:0,},{day:"Saturday",count:0,},{day:"Sunday",count:0,}]
        var hourList=[{day:"0",count:0,},{day:"1",count:0,},{day:"2",count:0,},{day:"3",count:0,},
        {day:"4",count:0,},{day:"5",count:0,},{day:"6",count:0,},{day:"7",count:0,},{day:"8",count:0,},{day:"9",count:0,},
        {day:"10",count:0,},{day:"11",count:0,},{day:"12",count:0,},{day:"13",count:0,},{day:"14",count:0,},
        {day:"15",count:0,},{day:"16",count:0,},{day:"17",count:0,},{day:"18",count:0,},{day:"19",count:0,},
        {day:"20",count:0,},{day:"21",count:0,},{day:"22",count:0,},{day:"23",count:0,}]
        for ( i = 0; i < dataAll.length; i++){
            comment=dataAll[i]
            for ( j=0;j<dayList.length;j++){
                if(comment.day==dayList[j].day){
                    dayList[j].count+=1;
                    break;}
            }
            for ( j=0;j<hourList.length;j++){
                if(comment.time==hourList[j].day){
                    hourList[j].count+=1;
                    break;
                }
            }
        }
         var dayListSelect=[{day:"Monday",count:0,},{day:"Tuesday",count:0,},{day:"Wednesday",count:0,},{day:"Thursday",count:0,},
        {day:"Friday",count:0,},{day:"Saturday",count:0,},{day:"Sunday",count:0,}]
        var hourListSelect=[{day:"0",count:0,},{day:"1",count:0,},{day:"2",count:0,},{day:"3",count:0,},
        {day:"4",count:0,},{day:"5",count:0,},{day:"6",count:0,},{day:"7",count:0,},{day:"8",count:0,},{day:"9",count:0,},
        {day:"10",count:0,},{day:"11",count:0,},{day:"12",count:0,},{day:"13",count:0,},{day:"14",count:0,},
        {day:"15",count:0,},{day:"16",count:0,},{day:"17",count:0,},{day:"18",count:0,},{day:"19",count:0,},
        {day:"20",count:0,},{day:"21",count:0,},{day:"22",count:0,},{day:"23",count:0,}]
        for ( i = 0; i < data.length; i++){
            comment=data[i]
            for ( j=0;j<dayListSelect.length;j++){
                if(comment.day==dayListSelect[j].day){
                    dayListSelect[j].count+=1;
                    break;}
            }
            for ( j=0;j<hourListSelect.length;j++){
                if(comment.time==hourListSelect[j].day){
                    hourListSelect[j].count+=1;
                    break;
                }
            }
        }
        const barWidth=500;
        const barHeight=400;
        const barmargin = { top: 20, right: 40, bottom: 160, left: 40, gap:40 };
        const barinnerWidth = barWidth - barmargin.left - barmargin.right - barmargin.gap;
        const barinnerHeight = barHeight - barmargin.top - barmargin.bottom - barmargin.gap;
        var barData=hourList;
        var barDataSelect=hourListSelect;
        if (barMode==1){
            barData=dayList;
            barDataSelect=dayListSelect;
        }
        else if (barMode==2){
            barData=hourList; 
            barDataSelect=hourListSelect;       
        }
        const changeHandler = (event) => {
            setbarMode(event.target.value);
        }
        
        //bar chart constants end --------------------------------------------------------------------------------------------------------
        return <div>
             <div style={{position: "absolute", textAlign: "left", width: "400px",left:"40px", top:"40px"}}>
                <h1 style={{color: "purple"}}>In The Mood Of Hate</h1>
                <p>Weibo Sexist hate Speech Analysis</p>
                <p>A lot of descriptions</p>
            </div>
            <svg width={1100} height={890}>
                <g>
                    <SymbolMap x={mapmargin.left} y={mapmargin.top} height={mapinnerHeight+mapmargin.gap} mouseOver={mouseOver} mouseOut={mouseOver}
                    width={mapinnerWidth/2} data={locationList} map={map}location={location}setLocation={setLocation} dataAll={locationAll}
                    hovlocation={hovlocation} setHovlocation={hovlocation} click={click} unclick={unclick}/>
                </g>   
            </svg>
           <div class="barChart"> <div> <select onChange={changeHandler}>
            <option value ={2}>Hours In a Day</option>
            <option value ={1}>Days In a Week</option>
            </select></div>
            <svg transform={`translate(${-10}, ${0})`} width={barWidth-75} height={barHeight-120}>
                   <BarChart barMode={barMode} height={barinnerHeight+barmargin.gap} width={barinnerWidth} data={barData} dataSelected={barDataSelect} 
                   margin={barmargin} location={location}
                    />
            </svg></div>
            
        </div>
    }
    ReactDOM.render( <Graph />, document.getElementById('root'));
    </script>
    </body>
    <style>
    body { 
        font-family: "Poppins", sans-serif;
    }

    .land {
        fill:rgb(141, 155, 136);
    } 

    .interiors {
        fill: none;
        stroke: #C0C0BB;
        stroke-width: 1px;
    } 
    .boundary {
        fill: #c9c9c9;
        stroke: #443a3a;
    }
    .selectedBoundary {
        fill: #a083a1;
        stroke: #443a3a;
    }

    .sphere {
        fill:rgba(241, 37, 37, 0.596);
        cursor: pointer;
    }

    .sphereCenter {
        fill:rgb(77, 32, 32);
    }
    .bar {
        fill:rgb(186, 174, 202);
    }
    .barSelected {
        fill:rgb(56, 53, 61);
    }

    div.barChart{
        position: absolute;
        top: 550px;
        left:1100px;
    }
    </style>
    </html>

      